name: Backend hvm dev CI/CD

on:
    push:
      branches:
        - dev
  
jobs:
    build-and-push:
      runs-on: ubuntu-22.04
  
      steps:
        # Checkout source code
        - name: Checkout source code
          uses: actions/checkout@v3
  
  
        # Log in to Docker Hub
        - name: Log in to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  
        # Build and push Docker image
        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
            context: .
            push: true
            tags: ${{ secrets.DOCKER_USERNAME }}/hvm-be:dev
            build-args: | 
              PORT=4002
  
    deploy:
      needs: build-and-push
      runs-on: ubuntu-latest
  
      steps:
        # SSH and deploy
        - name: Deploy to server
          uses: appleboy/ssh-action@v0.1.6
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            password: ${{ secrets.SERVER_PASSWORD }}
            script_stop: true
            script: |
              set -e
              cd /var/server/dev/hvm-be
              docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_ACCESS_TOKEN }}
              docker pull ${{ secrets.DOCKER_USERNAME }}/hvm-be:dev
              docker compose -p hvm-be-dev down
              docker compose -p hvm-be-dev up -d
              docker image prune -f